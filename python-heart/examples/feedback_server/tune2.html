<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Titl</title>



<style type="text/css">
  #slider { margin: 10px; }
</style>

<!-- Our javascript code -->

<script type="text/javascript">


window.onload = init;



var context;
var synthNote;

var wavetable;
var frequencyData;
var analyser;
var analyserView1;
var views;

var FREQ1 = 200;
var FREQ2 = 400;
var FREQ3 = 500;
var FILTERCUTOFF = 24000;
var RESONANCE = 3;

//----------------------------------------------------------------------------------------------------

function SynthNote() {
    this.detune = 0;
    this.snapToDetune = 0;
    this.resonance = RESONANCE;

    var osc1 = context.createOscillator();
  
  
    osc1.type = "sine";
  
    osc1.frequency.value = FREQ1;


    osc1.start(0);


    var noiseSource1 = createRandomPitchSource();
 
    noiseSource1.connect(osc1.frequency);

    
    
    var gainNode = context.createGain();
    gainNode.gain.value = 1;

    var resonanceGainNode = context.createGain();
    
    
    var filter = context.createBiquadFilter();
    filter.Q.value = this.resonance ;
    filter.frequency.value = FILTERCUTOFF;

    var filter2 = context.createBiquadFilter();
    filter2.Q.value = this.resonance;
    filter2.frequency.value = FILTERCUTOFF;

    filter.connect(filter2);
    filter2.connect(gainNode);

    gainNode.connect(resonanceGainNode);
    resonanceGainNode.connect(analyser);

    
    
    var dest = filter;

    osc1.connect(dest);

    
    //
    this.osc1 = osc1;
 
    this.noiseSource1 = noiseSource1;


    this.gainNode = gainNode;
    this.resonanceGainNode = resonanceGainNode;
    this.filter = filter;
    this.filter2 = filter2;
}

SynthNote.prototype.setFrequency1 = function(value) {
    this.osc1.frequency.value = value;
}

SynthNote.prototype.setFrequency2 = function(value) {
    this.osc2.frequency.value = value;
}

SynthNote.prototype.setFrequency3 = function(value) {
    this.osc3.frequency.value = value;
}

SynthNote.prototype.setDetune = function(value) {
    this.detune = value;
    this.snapToDetune = 20
}

SynthNote.prototype.setFilterFrequency = function(value) {
    this.filter.frequency.value = value;
    this.filter2.frequency.value = value
}

SynthNote.prototype.setFilterResonance = function(value) {
    this.filter.Q.value = value;
    this.filter2.Q.value = value - 6;

    // Resonance gain compensation.
    var gain = Math.pow(10, -value * 0.05);
    this.resonanceGainNode.gain.setTargetValueAtTime(gain, 0, 0.020);
}

SynthNote.prototype.setRandomization = function(value) {
    this.noiseSource1.gain.value = 0.01*value * this.osc1.frequency.value;
    this.noiseSource2.gain.value = 0.01*value * this.osc2.frequency.value;
    this.noiseSource3.gain.value = 0.01*value * this.osc3.frequency.value;
}

SynthNote.prototype.setGain = function(value) {
    this.gainNode.gain.value = value
}

SynthNote.prototype.handleDetune = function() {
    var t = 0; //context.currentTime;
    var maxDetune = 50; //1200;
    // var d1 = (2*Math.random() - 1) * 0.5*maxDetune;
    // var d2 = (2*Math.random() - 1) * 0.5*maxDetune;
    // var d3 = (2*Math.random() - 1) * 0.5*maxDetune;
    var d1 = 0;
    var d2 = 0;
    var d3 = 0;
    var k = 1;
    
    if (this.snapToDetune > 0) {
        k = 0.010;
        d1 = 0;
        d2 = 0;
        d3 = 0;
        --this.snapToDetune;
    }
    this.osc1.detune.setTargetValueAtTime(this.detune + d1, t, k);
    this.osc2.detune.setTargetValueAtTime(this.detune + d2, t, k);
    this.osc3.detune.setTargetValueAtTime(this.detune + d3, t, k);
}


function createNoiseBuffer() {
    var n =  5 * context.sampleRate;
    var buffer = context.createBuffer(1, n, context.sampleRate);
    var p = buffer.getChannelData(0);
    
    for (var i = 0; i < n; ++i) {
        var x = 2*Math.random() - 1;        
        p[i] = x;
    }

    return buffer;
}

function createRandomPitchSource() {
    var noiseBuffer = createNoiseBuffer();
    var noiseSource = context.createBufferSource();
    noiseSource.buffer = noiseBuffer;
    noiseSource.loop = true;
    
    var cutoff = 1;
    var noiseLowpass = context.createBiquadFilter();
    noiseLowpass.frequency.value = cutoff;
    noiseLowpass.frequency.Q = 0;
    
    var noiseGain = context.createGain();
    noiseGain.gain.value = 1;
        
    noiseSource.connect(noiseLowpass);
    noiseLowpass.connect(noiseGain);
    noiseSource.start(0);
    
    return noiseGain;
}



function initAudio() {
    context = new webkitAudioContext();
    
    // 
    analyser = context.createAnalyser();
    analyser.fftSize = 2048;
    analyser.connect(context.destination);

    synthNote = new SynthNote();


 
}

function init() {


    initAudio();

}







</script>
</head>

<body style="-webkit-user-select: none;"  ondragstart="return false;" ondrop="return false;">



</body>
</html>
